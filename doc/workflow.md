# Workflow
* Note: Map names containing an 'X' (for eXpansion) are Frozen Throne maps

## Background
* Warcraft 3 map files are basically fancy .mpq files
* Zezula's MPQEditor can extract the map files so they can be checked into git with plaintext triggers and re-pack them for use in game or in editor
    * [Download it here](http://www.zezula.net/en/mpq/download.html)
* The editor's save functionality compresses the maps significantly, at the cost of wiping out comments, spacing, and some metadata. A test on Human01 showed:

| state                                         | size         |
| --------------------------------------------- | ------------ |
| original file                                 | 241744 bytes |
| saved with World edit                         | 240858 bytes |
| original repacked with MPQEditor              | 371582 bytes |
| saved repacked with MPQEditor                 | 370719 bytes |
| original reloaded into World Editor and saved | 240879 bytes |
| saved reloaded into World Editor and saved    | 240770 bytes |

Making a new map file with MPQEditor seems to make it significantly larger. However, it's possible to remove files from an existing map file; by making a template `empty.w3x`, using MPQEditor to remove all files from it, then adding desired files, we can keep the compression. The secret sauce seems to live in the `(attributes)` file, which I'm not sure how to edit from MPQEditor. The difference is only a handful of bytes for Human01.

| state                                                       | size         |
| ----------------------------------------------------------- | ------------ |
| take existing .w3m, remove all files, add all desired files | 240894 bytes |
| open and save above in WorldEdit                            | 240820 bytes |

Note that map files also store flags outside of the MPQ region; these will also have to be accounted for in such a tool

### Making an empty .w3x
Run mpqeditor console with `mpqeditor /console` in the directory containing the unprocessed empty.w3x.

```sh
open empty.w3x
list empty.w3x
# For every filename listed
d empty.w3x <filename>
list empty.w3x
```

## Workflow
* Extract original map files from Warcraft 3 install with MPQEditor
* Extract map files into exploded directories under `work/`
  * This is the root of future edits
* Repack map files with MPQEditor under `out/`
* **Optional** Reload and save map files with WorldEdit
* Changes made in WorldEdit can be extracted and ported back to `work/`, with two exceptions:
  * .wts files (strings) should be ported piecemeal to preserve comments
  * .j files (jass scripts) should be ported piecemeal to preserve code formatting
  * All other files are binary files and should be possible to port back on a per-file basis *unverified*

## Helper scripts
* `mapfile/pack.py` -- packs an extracted directory into a map file
* `mapfile/unpack.py` -- unpacks a map file into an extract directory
* `scripts/reformat_jass.py` -- Reformats whitespace, comments, and basic function replacements to make .j scripts closer to what is generated by saving in the editor. Does not handle moving sections around. Intended to somewhat separate formatting and semantic diffs when saving RoC maps as TFT.

### Configuration
* The scripts try to read a workspace.ini file for executable paths and script arguments. This allows a developer to set and reuse arguments for a current task

## Updating a map
There are several to-do list items when updating a vanilla map to AP
* Reformat .j script whitespace with `reformat_jass.py`
  * (this makes semantic differences when saving in-editor easier to review)
* Open the map file in the editor and save it
* Add AP items I010 ~ I023
* Add Archipelago triggers
  * fileio.j, map_config.j, status.j, heroes.j, item_locations.j
    * map_config.j requires filling in all the map-specific details
* Other trigger changes
  * Make custom hero_init function
  * Remove hero level limit triggers
  * Remove gamecache load/store triggers
  * Change next mission startup to point to AP mission
* Locations
  * Change drop tables
  * (RoC) Remove crate drop triggers / replace with drop tables
  * Add triggers to send locations for actions
  * Update goblin merchants to sell location items

### RoC
* Creep stat changes / money drop changes (w3u)
* RoC/TFT stat adjustments
* Disable TFT additions (all players)
  * heroes (w3i, technologies)
  * units (w3i, technologies)
  * Techs (w3i, upgrades)

| TFT Hero      | ID   | Search hero  | Search Hero ID |
| ------------- | ---- | ------------ | -------------- |
| Blood Mage    | Hblm | Paladin      | Hpal           |
| Shadow Hunter | Oshd | Blademaster  | Obla           |
| Crypt Lord    | Ucrl | Dreadlord    | Udre           |
| Warden        | Ewar | Demon Hunter | Edem           |

| TFT Unit         | ID   |
| ---------------- | ---- |
| Spell Breaker    | hspt |
| Dragonhawk Rider | hdhw |
| Troll Batrider   | otbr |
| Spirit Walker    | ospm |
| Obsidian Statue  | uobs |
| Faerie Dragon    | efdr |
| Mountain Giant   | emtg |
| Arcane Tower     | hatw |
| Nerubian Tower   | uzg2 |

| TFT tech              | ID   |
| --------------------- | ---- |
| Human Backpack        | Rhpm |
| Sundering Blades      | Rhsb |
| Fragmentation Shards  | Rhsb |
| Flak Cannons          | Rhfc |
| Barrage               | Rhrt |
| Cloud                 | Rhcd |
| Orc Backpack          | Ropm |
| Reinforced Defenses   | Rorb |
| Berserker Upgrade     | Robk |
| Burning Oil           | Robf |
| Spirit Walker Adept Training,Spirit Walker Master Training | Rowt |
| Liquid Fire           | Rolf |
| Undead Backpack       | Rupm |
| Burrow                | Rubu |
| Skeletal Mastery      | Rusm |
| Exhume Corpses        | Ruex |
| Destroyer Form        | Rusp |
| Night Elf Backpack    | Repm |
| Wellspring            | Rews |
| Hardened Skin         | Rehs |
| Resistant Skin        | Rers |
| Mark of the Claw      | Reeb |
| Mark of the Talon     | Reec |
